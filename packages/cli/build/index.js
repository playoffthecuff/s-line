#!/usr/bin/env node
// @bun
import{Command as ge}from"commander";import M from"inquirer";import R from"path";import n from"zod/v4";var N=n.array(n.object({path:n.string(),target:n.string().optional()})).min(1).refine((e)=>new Set(e.map((t)=>t.path)).size===e.length,{error:"duplicate file"}),w=n.object({name:n.string(),regDeps:n.array(n.string()).optional(),pkgDeps:n.array(n.string()).optional(),files:N}),j=n.object({name:n.string(),url:n.url(),items:n.array(w).refine((e)=>new Set(e.map((t)=>t.name)).size===e.length,{error:"duplicate name"})}),d=n.array(n.object({path:n.string(),content:n.string()})),m=n.object({name:n.string(),regDeps:n.array(n.string()).optional(),pkgDeps:n.array(n.string()).optional(),files:d});import u from"fs";import{exec as T}from"child_process";import{promisify as A}from"util";import J from"path";var O={bun:"bun.lock",pnpm:"pnpm-lock.yaml",yarn:"yarn.lock",npm:"package-lock.json"},U=()=>Object.entries(O).find(([e,t])=>u.existsSync(t))?.[0]??"npm",v=A(T),B=(e)=>{let t=process.cwd(),s=J.join(t,"package.json");if(!u.existsSync(s))return!1;let r=JSON.parse(u.readFileSync(s,"utf8"));return Boolean(r.dependencies?.[e]||r.devDependencies?.[e]||r.peerDependencies?.[e])},_=async(e,t)=>{let s=U(),r={bun:`bun add ${t?"-D ":""}${e.join(" ")}`,pnpm:`pnpm add ${t?"-D ":""}${e.join(" ")}`,yarn:`yarn add ${t?"-D ":""}${e.join(" ")}`,npm:`npm install ${t?"-D ":""}${e.join(" ")}`}[s];if(console.log(`\uD83D\uDCE6 Installing ${e.join(", ")} using ${s}...`),r)await v(r)},p=async(e,t)=>{let s=e.filter((r)=>!B(r));if(s.length===0){console.log(`\u2714 All ${t?"dev ":""}deps already installed: ${e.join(", ")}`);return}console.log(`\uD83D\uDCE6 Installing ${s.join(", ")}`);try{await _(s,t)}catch(r){console.error("\u274C Install error:",r)}};import{existsSync as q,mkdirSync as G,writeFileSync as W}from"fs";import Y from"zod/v4";var H="https://smoothed.vercel.app/registry";var K=async(e)=>{let s=await(await fetch(e)).json();return m.parse(s)};var x=async(e,t=new Set)=>{let s=e.split(/(.+\/).+.json$/)[1];if(!s)throw new Error(`Invalid URL ${e}`);if(t.has(e))return[];t.add(e);let r=[],o=await K(e);if(o.regDeps?.length)for(let i of o.regDeps){let c=await x(`${s}${i}.json`,t);r.push(...c)}return[...r,o]},Q=(e,t)=>{let s=d.safeParse(e);if(!s.success)throw new Error("Invalid object structure");for(let r of s.data){if(q(r.path))continue;let o=r.path.split(/^(.+)\/.+$/)[1];if(o)G(R.join(t,o),{recursive:!0}),W(R.join(t,r.path),r.content)}},X=async(e,t)=>{let s=[...new Set(e.reduce((o,i)=>{if(i.pkgDeps?.length)o.push(...i.pkgDeps);return o},[]))];p(s);let r=[...new Set(e.reduce((o,i)=>(o.push(...i.files),o),[]))];Q(r,t)},Z=Y.url(),D=async(e)=>{if(!e){let{component:i}=await M.prompt([{type:"input",name:"component",message:"Component name:"}]);e=i}let t=e.trim().toLowerCase(),s=Z.safeParse(t),r=s.success?s.data:`${H}/${t}.json`,o=await x(r);await X(o,process.cwd())};import g from"path";import{readdirSync as V,statSync as ee}from"fs";import te from"path";var S=(e,t)=>{let s=V(e);for(let r of s){let o=te.join(e,r);if(ee(o).isDirectory()){let c=S(o,t);if(c)return c}else if(r===t)return o}return null};import{readFileSync as oe,writeFileSync as ie}from"fs";import{readFile as ae}from"fs/promises";var I=(e)=>{try{return{right:JSON.parse(e),left:null}}catch(t){return{right:null,left:t}}};var re=(e)=>e.replace(/\r\n/g,`
`),se=(e)=>e.replace(/[ \t]+$/gm,""),ne=(e)=>e.replace(/\n?$/,`
`),$=(e)=>re(se(ne(e)));var ce="public",b=process.cwd(),pe=g.join(b,ce),k=async()=>{let e=S(pe,"registry.json");if(!e)throw new Error("'registry.json' was not found in '/public' of your work directory");let t=g.dirname(e),s=oe(e,"utf-8"),r=I(s);if(r.left)throw r.left;let o=r.right,i=j.safeParse(o);if(!i.success)throw i.error;let c=i.data;for(let a of c.items){let F=[];for(let l of a.files){let L=g.join(b,l.path);try{let E=await ae(L,{encoding:"utf-8"});F.push({content:$(E),path:l.target??l.path})}catch{throw new Error(`Failed to read source file ${l.path}`)}}let f={files:F,name:a.name};if(a.regDeps)f.regDeps=a.regDeps;if(a.pkgDeps)f.pkgDeps=a.pkgDeps;let h=m.safeParse(f);if(!h.success)throw h.error;let z=h.data,C=g.join(t,`${a.name}.json`);ie(C,JSON.stringify(z,null,2),"utf-8")}};var le=["unocss","@unocss/postcss","@unocss/preset-wind4"],me=["@base-ui/react"],P=async()=>{await p(me),await p(le,!0)};var y=new ge;y.command("init").description("Add dependencies to project").action(P);y.command("add [name]").description("Add component to your project").action(D);y.command("build").description("Build registry").action(k);try{y.parse()}catch(e){console.error(e),process.exit(1)}
