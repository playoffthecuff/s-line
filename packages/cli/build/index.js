#!/usr/bin/env node
// @bun
import{Command as me}from"commander";import U from"inquirer";import B from"path";import n from"zod/v4";var L=n.array(n.object({path:n.string(),target:n.string().optional()})).min(1).refine((e)=>new Set(e.map((t)=>t.path)).size===e.length,{error:"duplicate file"}),j=n.object({name:n.string(),regDeps:n.array(n.string()).optional(),pkgDeps:n.array(n.string()).optional(),files:L}),R=n.object({name:n.string(),url:n.url(),items:n.array(j).refine((e)=>new Set(e.map((t)=>t.name)).size===e.length,{error:"duplicate name"})}),u=n.array(n.object({path:n.string(),content:n.string()})),m=n.object({name:n.string(),regDeps:n.array(n.string()).optional(),pkgDeps:n.array(n.string()).optional(),files:u});import S from"fs";import{exec as N}from"child_process";import{promisify as O}from"util";import J from"path";var T={bun:"bun.lock",pnpm:"pnpm-lock.yaml",yarn:"yarn.lock",npm:"package-lock.json"},A=()=>Object.entries(T).find(([e,t])=>S.existsSync(t))?.[0]??"npm",M=O(N),_=(e)=>{let t=process.cwd(),s=J.join(t,"package.json");if(!S.existsSync(s))return!1;let r=JSON.parse(S.readFileSync(s,"utf8"));return Boolean(r.dependencies?.[e]||r.devDependencies?.[e]||r.peerDependencies?.[e])},v=async(e,t)=>{let s=A(),r={bun:`bun add ${t?"-D ":""}${e.join(" ")}`,pnpm:`pnpm add ${t?"-D ":""}${e.join(" ")}`,yarn:`yarn add ${t?"-D ":""}${e.join(" ")}`,npm:`npm install ${t?"-D ":""}${e.join(" ")}`}[s];if(console.log(`\uD83D\uDCE6 Installing ${e.join(", ")} using ${s}...`),r)await M(r)},p=async(e,t)=>{let s=e.filter((r)=>!_(r));if(s.length===0){console.log(`\u2714 All ${t?"dev ":""}deps already installed: ${e.join(", ")}`);return}console.log(`\uD83D\uDCE6 Installing ${s.join(", ")}`);try{await v(s,t)}catch(r){console.error("\u274C Install error:",r)}};import{existsSync as q,writeFileSync as G}from"fs";var g=(e)=>{try{return{right:JSON.parse(e),left:null}}catch(t){return{right:null,left:t}}};import V from"zod/v4";var W="https://smoothed.vercel.app/registry";var Y=async(e)=>{let s=await(await fetch(e)).json(),r=JSON.parse(s);return m.parse(r)};var D=async(e,t=new Set)=>{let s=e.split(/(.+\/)[a-z]+\.json$/)[1];if(!s)throw new Error(`Invalid URL ${e}`);if(t.has(e))return[];t.add(e);let r=[],o=await Y(e);if(o.regDeps?.length)for(let i of o.regDeps){let c=await D(`${s}${i}`,t);r.push(...c)}return[...r,o]},H=(e,t)=>{let s=u.safeParse(e);if(!s.success)throw new Error("Invalid object structure");for(let r of s.data){if(q(r.path))continue;let{left:o,right:i}=g(r.content);if(o)throw new Error("Invalid JSON content");G(B.join(t,r.path),i)}},K=async(e,t)=>{let s=[...new Set(e.reduce((o,i)=>{if(i.pkgDeps?.length)o.push(...i.pkgDeps);return o},[]))];p(s);let r=[...new Set(e.reduce((o,i)=>(o.push(...i.files),o),[]))];H(r,t)},Q=V.url(),x=async(e)=>{if(!e){let{component:i}=await U.prompt([{type:"input",name:"component",message:"Component name:"}]);e=i}let t=e.trim().toLowerCase(),s=Q.safeParse(t),r=s.success?s.data:`${W}/${t}.json`,o=await D(r);await K(o,process.cwd())};import y from"path";import{readdirSync as X,statSync as Z}from"fs";import ee from"path";var F=(e,t)=>{let s=X(e);for(let r of s){let o=ee.join(e,r);if(Z(o).isDirectory()){let c=F(o,t);if(c)return c}else if(r===t)return o}return null};import{readFileSync as ne,writeFileSync as oe}from"fs";import{readFile as ie}from"fs/promises";var te=(e)=>e.replace(/\r\n/g,`
`),re=(e)=>e.replace(/[ \t]+$/gm,""),se=(e)=>e.replace(/\n?$/,`
`),I=(e)=>te(re(se(e)));var ae="public",b=process.cwd(),ce=y.join(b,ae),$=async()=>{let e=F(ce,"registry.json");if(!e)throw new Error("'registry.json' was not found in '/public' of your work directory");let t=y.dirname(e),s=ne(e,"utf-8"),r=g(s);if(r.left)throw r.left;let o=r.right,i=R.safeParse(o);if(!i.success)throw i.error;let c=i.data;for(let a of c.items){let w=[];for(let l of a.files){let z=y.join(b,l.path);try{let C=await ie(z,{encoding:"utf-8"});w.push({content:I(C),path:l.target??l.path})}catch{throw new Error(`Failed to read source file ${l.path}`)}}let h={files:w,name:a.name};if(a.regDeps)h.regDeps=a.regDeps;if(a.pkgDeps)h.pkgDeps=a.pkgDeps;let d=m.safeParse(h);if(!d.success)throw d.error;let P=d.data,E=y.join(t,`${a.name}.json`);oe(E,JSON.stringify(P,null,2),"utf-8")}};var pe=["unocss","@unocss/postcss","@unocss/preset-wind4"],le=["@base-ui/react","class-variance-authority","clsx"],k=async()=>{await p(le),await p(pe,!0)};var f=new me;f.command("init").description("Add dependencies to project").action(k);f.command("add [name]").description("Add component to your project").action(x);f.command("build").description("Build registry").action($);try{f.parse()}catch(e){console.error(e),process.exit(1)}
