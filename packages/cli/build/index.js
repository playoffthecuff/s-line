#!/usr/bin/env node
// @bun
import{Command as he}from"commander";import G from"inquirer";import l from"path";import{fileURLToPath as V}from"url";import n from"zod/v4";var T=n.array(n.object({path:n.string(),target:n.string().optional()})).min(1).refine((e)=>new Set(e.map((t)=>t.path)).size===e.length,{error:"duplicate file"}),F=n.object({name:n.string(),regDeps:n.array(n.string()).optional(),pkgDeps:n.array(n.string()).optional(),files:T}),R=n.object({name:n.string(),url:n.url(),items:n.array(F).refine((e)=>new Set(e.map((t)=>t.name)).size===e.length,{error:"duplicate name"})}),x=n.array(n.object({path:n.string(),content:n.string()})),d=n.object({name:n.string(),regDeps:n.array(n.string()).optional(),pkgDeps:n.array(n.string()).optional(),files:x});import w from"fs";import{exec as J}from"child_process";import{promisify as v}from"util";import A from"path";var M={bun:"bun.lock",pnpm:"pnpm-lock.yaml",yarn:"yarn.lock",npm:"package-lock.json"},U=()=>Object.entries(M).find(([e,t])=>w.existsSync(t))?.[0]??"npm",_=v(J),B=(e)=>{let t=process.cwd(),s=A.join(t,"package.json");if(!w.existsSync(s))return!1;let r=JSON.parse(w.readFileSync(s,"utf8"));return Boolean(r.dependencies?.[e]||r.devDependencies?.[e]||r.peerDependencies?.[e])},q=async(e,t)=>{let s=U(),r={bun:`bun add ${t?"-D ":""}${e.join(" ")}`,pnpm:`pnpm add ${t?"-D ":""}${e.join(" ")}`,yarn:`yarn add ${t?"-D ":""}${e.join(" ")}`,npm:`npm install ${t?"-D ":""}${e.join(" ")}`}[s];if(console.log(`\uD83D\uDCE6 Installing ${e.join(", ")} using ${s}...`),r)await _(r)},f=async(e,t)=>{let s=e.filter((r)=>!B(r));if(s.length===0){console.log(`\u2714 All ${t?"dev ":""}deps already installed: ${e.join(", ")}`);return}console.log(`\uD83D\uDCE6 Installing ${s.join(", ")}`);try{await q(s,t)}catch(r){console.error("\u274C Install error:",r)}};import{mkdirSync as W,copyFileSync as Y,existsSync as Ee,writeFileSync as ze}from"fs";import{readFile as H}from"fs/promises";var j=(e)=>{try{return{right:JSON.parse(e),left:null}}catch(t){return{right:null,left:t}}};import K from"zod/v4";var Q="https://smoothed.vercel.app/registry",X=V(import.meta.url),I=l.dirname(X),Z=async(e,t)=>{let s=l.join(e,t),r=await H(s,"utf-8"),o=JSON.parse(r);return F.parse(o)},ee=async(e)=>{let s=await(await fetch(e)).json(),r=JSON.parse(s);return d.parse(r)},b=async(e,t,s=new Set)=>{if(s.has(t))return[];s.add(t);let r=[],o=await Z(e,t);if(o.regDeps?.length)for(let i of o.regDeps){let a=await b(e,i,s);r.push(...a)}return[...r,o]},k=async(e,t=new Set)=>{let s=e.split(/(.+\/)[a-z]+\.json$/)[1];if(!s)throw new Error(`Invalid URL ${e}`);if(t.has(e))return[];t.add(e);let r=[],o=await ee(e);if(o.regDeps?.length)for(let i of o.regDeps){let a=await k(`${s}${i}`,t);r.push(...a)}return[...r,o]};var te=K.url(),$=async(e)=>{if(!e){let{component:p}=await G.prompt([{type:"input",name:"component",message:"Component name:"}]);e=p}let t=e.trim().toLowerCase(),s=te.safeParse(t),r=s.success?s.data:`${Q}/${t}.json`,o=l.join(process.cwd(),"src"),i=l.join(I,"../src","registry","schema"),a=l.join(I,"../src","templates"),c=s.success?await k(r):await b(i,e.toLowerCase()+".json");for(let p of c){if(p.pkgDeps?.length)await f(p.pkgDeps);if(p.files.length)for(let m of p.files){let g=l.join(a,"components",m.path),y=l.join(o,"components/ui",m.path);W(l.dirname(y),{recursive:!0}),Y(g,y)}}};import u from"path";import{readdirSync as re,statSync as se}from"fs";import ne from"path";var D=(e,t)=>{let s=re(e);for(let r of s){let o=ne.join(e,r);if(se(o).isDirectory()){let a=D(o,t);if(a)return a}else if(r===t)return o}return null};import{readFileSync as ce,writeFileSync as pe}from"fs";import{readFile as le}from"fs/promises";var oe=(e)=>e.replace(/\r\n/g,`
`),ie=(e)=>e.replace(/[ \t]+$/gm,""),ae=(e)=>e.replace(/\n?$/,`
`),P=(e)=>oe(ie(ae(e)));var me="public",E=process.cwd(),ge=u.join(E,me),z=async()=>{let e=D(ge,"registry.json");if(!e)throw new Error("'registry.json' was not found in '/public' of your work directory");let t=u.dirname(e),s=ce(e,"utf-8"),r=j(s);if(r.left)throw r.left;let o=r.right,i=R.safeParse(o);if(!i.success)throw i.error;let a=i.data;for(let c of a.items){let p=[];for(let h of c.files){let N=u.join(E,h.path);try{let O=await le(N,{encoding:"utf-8"});p.push({content:P(O),path:h.target??h.path})}catch{throw new Error(`Failed to read source file ${h.path}`)}}let m={files:p,name:c.name};if(c.regDeps)m.regDeps=c.regDeps;if(c.pkgDeps)m.pkgDeps=c.pkgDeps;let g=d.safeParse(m);if(!g.success)throw g.error;let y=g.data,C=u.join(t,`${c.name}.json`);pe(C,JSON.stringify(y,null,2),"utf-8")}};var fe=["unocss","@unocss/postcss","@unocss/preset-wind4"],ye=["@base-ui/react","class-variance-authority","clsx"],L=async()=>{await f(ye),await f(fe,!0)};var S=new he;S.command("init").description("Add dependencies to project").action(L);S.command("add [name]").description("Add component to your project").action($);S.command("build").description("Build registry").action(z);try{S.parse()}catch(e){console.error(e),process.exit(1)}
